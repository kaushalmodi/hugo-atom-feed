{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\" ?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom"{{ with site.LanguageCode }} xml:lang="{{.}}"{{- end -}}>
  {{- $uuid := sha1 $.Site.BaseURL }}
  <id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
  <title type="html">
    {{- if ne .Title site.Title }}
      {{- with .Title }}{{. | html }} | {{- end -}}
    {{- end -}}
    {{- site.Title | html }}
    {{- if .IsTranslated }} ({{- index site.Data.i18n.languages .Lang }}){{- end -}}
  </title>
  {{- if (.Params.Subtitle) and (ne .Params.Subtitle "") }}
    <subtitle type="html">
      {{- .Params.Subtitle | html -}}
    </subtitle>
  {{- else if ($.Site.Params.Subtitle) and (ne $.Site.Params.Subtitle "") }}
    <subtitle type="html">
      {{- $.Site.Params.Subtitle | html -}}
    </subtitle>
  {{- end }}
  {{ with .OutputFormats.Get "HTML" }}
    {{- printf "<link href=%q rel=\"alternate\" type=%q title=\"Website\" />" .Permalink .MediaType | safeHTML }}
  {{- end }}
  {{ with .OutputFormats.Get "ATOM" }}
    {{- printf "<link href=%q rel=\"self\" type=%q title=\"Atom/Modern feed format\" />" .Permalink .MediaType | safeHTML }}
  {{- end }}
  {{ with .OutputFormats.Get "RSS" }}
    {{- printf "<link href=%q rel=\"alternate\" type=%q title=\"RSS/Legacy feed format\" />" .Permalink .MediaType | safeHTML }}
  {{- end }}
  {{- range .Translations }}
    {{- $lang := .Lang }}
    {{- $langstr := index site.Data.i18n.languages .Lang }}
    {{ with .OutputFormats.Get "HTML" }}
      {{- printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"[%s] Website\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
    {{- end }}
    {{ with .OutputFormats.Get "ATOM" }}
      {{- printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"[%s] Atom/Modern feed format\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
    {{- end }}
    {{ with .OutputFormats.Get "RSS" }}
      {{- printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"[%s] RSS/Legacy feed format\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
    {{- end }}
  {{- end }}
  {{- if and (eq site.Params.comments.engine 1) (site.Params.comments.disqus.shortname) }}
    <link href="https://{{- site.Params.comments.disqus.shortname }}.disqus.com/comments.rss" rel="comments" type="application/rss+xml" />
  {{- end }}
  <generator uri="https://gohugo.io/" version="{{hugo.Version}}">Hugo</generator>
  {{- $author := site.GetPage (printf "/%s/%s" "authors" (.Scratch.Get "superuser_username")) }}
  {{ with site.Author.name }}
    <author>
      <name>{{ . | plainify }}</name>
      {{- with site.Author.email }}
        <email>{{ . | plainify }}</email>
      {{- end }}
    </author>
  {{- else }}
    {{- with $author }}
      <author>
        <name>{{ .Params.name }}</name>
        <uri>{{ .Permalink }}</uri>
        {{- /* with .Params.email }}
          <email>{{ . | plainify }}</email>
        {{ end */ -}}
      </author>
    {{- end -}}
  {{- end -}}
  {{ with site.Copyright }}
    <rights>
      {{- replace (replace . "{year}" now.Year) "&copy;" "Â©" | plainify -}}
    </rights>
  {{- end }}
  <updated>{{ now.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>
  <icon>
    {{- site.BaseURL }}img/icon-32.png{{- "" -}}
  </icon>
  <logo>
    {{- site.BaseURL }}img/icon-512.png{{- "" -}}
  </logo>

  {{- $limit := (cond (le site.Config.Services.RSS.Limit 0) 65536 site.Config.Services.RSS.Limit) }}
  {{- $feed_sections := $.Site.Params.feedSections | default site.Params.mainSections }}
  {{ range first $limit (where (where .Pages "Type" "in" $feed_sections) ".Params.DisableFeed" "!=" true ) }}
    {{ $page := . }}
    <entry>
      {{ printf `<title type="html"><![CDATA[%s]]></title>` .Title | safeHTML }}
      {{- $uuid := sha1 .RelPermalink }}
      <id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
      {{- with .Params.authors -}}
        {{- range . -}} <!-- Assuming the author front-matter to be a list -->
          {{- $author := site.GetPage (printf "/%s/%s" "authors" .) }}
          {{- if $author.Params.name }}
            {{- with $author }}
              <author>
                <name>{{ .Params.name }}</name>
                <uri>{{ .Permalink }}</uri>
                {{- /* with .Params.email }}
                  <email>{{ . | plainify }}</email>
                {{ end */ -}}
              </author>
            {{- end -}}
          {{- else }}
            <author>
              <name>{{ . }}</name>
            </author>
          {{- end -}}
        {{- end -}}
      {{- end }}
      <published>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</published>
      <updated>{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>
      <link href="{{ .Permalink }}?utm_source=atom_feed" rel="alternate" type="text/html" />
      {{- range .Translations }}
        {{- $link := printf "%s?utm_source=atom_feed" .Permalink | safeHTML }}
        {{- printf "<link href=%q rel=\"alternate\" type=\"text/html\" hreflang=%q />" $link .Lang | safeHTML }}
      {{- end }}
      {{- if site.Params.comments.engine | and (index site.Params.comments.commentable .Type) | and (ne .Params.commentable false) | or .Params.commentable }}
        <link href="{{ .Permalink }}?utm_source=atom_feed#comments" rel="service.post" type="text/html" />
      {{- end }}
      {{- range first 5 (site.RegularPages.Related .) }}
        <link href="{{ .Permalink }}?utm_source=atom_feed" rel="related" type="text/html" title="{{ .Title }}" />
      {{- end }}
      {{- if ne .Summary "" }}
        {{ printf `<summary type="html"><![CDATA[%s]]></summary>` .Summary | safeHTML }}
      {{- end }}
      {{- $description1 := .Description | default "" }}
      {{- $description := (cond (eq "" $description1) "" (printf "<blockquote>%s</blockquote>" ($description1 | markdownify | chomp ))) }}
      {{- if or (ne .Content "") (ne $description "") }}
        {{ printf `<content type="html"><![CDATA[%s%s]]></content>` $description .Content | safeHTML }}
      {{- end }}
      {{- with site.Taxonomies }}
        {{- range $taxo,$_ := . }} <!-- Defaults taxos: "tags", "categories" -->
          {{- with $page.Param $taxo }}
            {{- $taxo_list := . }} <!-- $taxo_list will be the tags/categories list -->
            {{- with site.GetPage (printf "/%s" $taxo) }}
              {{- $taxonomy_page := . }}
              {{- range $taxo_list }} <!-- Below, assuming pretty URLs -->
                <category scheme="{{ printf "%s%s" $taxonomy_page.Permalink (. | urlize) }}" term="{{ (. | urlize) }}" label="{{ . }}" />
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    </entry>
  {{ end }}
</feed>
